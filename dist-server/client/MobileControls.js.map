{"version":3,"sources":["../../src/client/MobileControls.js"],"names":["MobileControls","clientEngine","Object","assign","EventEmitter","prototype","renderer","touchContainer","document","querySelector","setupListeners","activeInput","up","left","right","onRequestAnimationFrame","handleMovementInput","window","requestAnimationFrame","gameEngine","on","keyName","sendInput","touchHandler","e","touch","targetTouches","currentTouch","x","pageX","y","pageY","type","emit","addEventListener","playerShip","preventDefault","onKeyChange","isDown","playerShipScreenCoords","gameCoordsToScreen","dx","dy","shortestArc","Utils","Math","atan2","sin","actor","shipContainerSprite","rotation","PI","cos","rotateThreshold","distanceThreshold","sqrt"],"mappings":"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","sourcesContent":["import EventEmitter from 'event-emitter';\r\nimport Utils from '../common/Utils';\r\n\r\n/**\r\n * This class handles touch device controls\r\n */\r\nexport default class MobileControls {\r\n\r\n    constructor(clientEngine){\r\n        Object.assign(this, EventEmitter.prototype);\r\n        this.clientEngine = clientEngine;\r\n        this.renderer = clientEngine.renderer;\r\n\r\n        this.touchContainer = document.querySelector('.pixiContainer');\r\n        this.setupListeners();\r\n\r\n        this.activeInput = {\r\n            up: false,\r\n            left: false,\r\n            right: false\r\n        };\r\n\r\n        let onRequestAnimationFrame = () => {\r\n            this.handleMovementInput();\r\n            window.requestAnimationFrame(onRequestAnimationFrame);\r\n        };\r\n        onRequestAnimationFrame();\r\n\r\n        this.clientEngine.gameEngine.on('client__preStep', ()=>{\r\n            for (let keyName in this.activeInput){\r\n                if (this.activeInput[keyName]){\r\n                    this.clientEngine.sendInput(keyName);\r\n                }\r\n            }\r\n        });\r\n\r\n    }\r\n\r\n    setupListeners(){\r\n        let touchHandler = (e) => {\r\n            // If there's exactly one finger inside this element\r\n            let touch = e.targetTouches[0];\r\n            this.currentTouch = {\r\n                x: touch.pageX,\r\n                y: touch.pageY\r\n            };\r\n\r\n            if (e.type === 'touchstart' && e.targetTouches[1]){\r\n                this.emit('fire');\r\n            }\r\n        };\r\n\r\n        this.touchContainer.addEventListener('touchstart', touchHandler, false);\r\n        this.touchContainer.addEventListener('touchmove', (e) =>{\r\n            touchHandler(e);\r\n            // if ingame prevent scrolling\r\n            if (this.renderer.playerShip) {\r\n                e.preventDefault();\r\n            }\r\n        }, false);\r\n\r\n        this.touchContainer.addEventListener('touchend', (e) => {\r\n            this.currentTouch = false;\r\n            this.activeInput.up = false;\r\n            this.activeInput.left = false;\r\n            this.activeInput.right = false;\r\n            this.renderer.onKeyChange({ keyName: 'up', isDown: false });\r\n        }, false);\r\n\r\n        document.querySelector('.fireButton').addEventListener('click', () => {\r\n            this.emit('fire');\r\n        });\r\n    }\r\n\r\n    handleMovementInput(){\r\n        // no touch, no movement\r\n        if (!this.currentTouch) return;\r\n\r\n        // by default no touch\r\n        this.activeInput.right = false;\r\n        this.activeInput.left = false;\r\n        this.activeInput.up = false;\r\n\r\n        let playerShip = this.renderer.playerShip;\r\n        // no player ship, no movement\r\n        if (!playerShip) return;\r\n\r\n        let playerShipScreenCoords = this.renderer.gameCoordsToScreen(playerShip);\r\n\r\n        let dx = this.currentTouch.x - playerShipScreenCoords.x;\r\n        let dy = this.currentTouch.y - playerShipScreenCoords.y;\r\n        let shortestArc = Utils.shortestArc(Math.atan2(dx, -dy),\r\n            Math.atan2(Math.sin(playerShip.actor.shipContainerSprite.rotation + Math.PI / 2), Math.cos(playerShip.actor.shipContainerSprite.rotation + Math.PI / 2)));\r\n\r\n        let rotateThreshold = 0.3;\r\n        let distanceThreshold = 120;\r\n\r\n        // turn left or right\r\n        if (shortestArc > rotateThreshold){\r\n            this.activeInput.left = true;\r\n            this.activeInput.right = false;\r\n        } else if (shortestArc < -rotateThreshold) {\r\n            this.activeInput.right = true;\r\n            this.activeInput.left = false;\r\n        }\r\n\r\n        // don't turn if too close\r\n        if (Math.sqrt(dx * dx + dy * dy) > distanceThreshold) {\r\n            this.activeInput.up = true;\r\n            this.renderer.onKeyChange({ keyName: 'up', isDown: true });\r\n        } else {\r\n            this.renderer.onKeyChange({ keyName: 'up', isDown: false });\r\n        }\r\n\r\n    }\r\n\r\n}\r\n"],"file":"MobileControls.js"}