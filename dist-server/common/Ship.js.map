{"version":3,"sources":["../../src/common/Ship.js"],"names":["Ship","gameEngine","options","props","showThrust","Renderer","renderer","getInstance","shipActor","ShipActor","sprite","sprites","id","position","set","x","y","layer2","addChild","isOwnedByPlayer","addPlayerShip","addOffscreenIndicator","fireLoop","destroy","onPreStep","removeListener","playerShip","removeOffscreenIndicator","actor","then","angleLocal","percent","max","isBot","other","steer","on","fireLoopTime","Math","round","random","timer","loop","target","distanceToTargetSquared","makeMissile","p1","p2","wrapDist","d","abs","dx","shortestVector","worldSettings","width","dy","height","closestTarget","closestDistance2","Infinity","Object","keys","world","objects","objId","obj","distance2","newVX","newVY","angleToTarget","atan2","PI","turnRight","angle","turnLeft","accelerate","assign","type","BaseTypes","TYPES","INT32","DynamicObject"],"mappings":"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","sourcesContent":["import { BaseTypes, DynamicObject, Renderer } from 'lance-gg';\r\nimport ShipActor from '../client/ShipActor';\r\n\r\nexport default class Ship extends DynamicObject {\r\n\r\n    constructor(gameEngine, options, props) {\r\n        super(gameEngine, options, props);\r\n        this.showThrust = 0;\r\n    }\r\n\r\n    get maxSpeed() { return 3.0; }\r\n\r\n    onAddToWorld(gameEngine) {\r\n        if (Renderer) {\r\n            let renderer = Renderer.getInstance();\r\n            let shipActor = new ShipActor(renderer);\r\n            let sprite = shipActor.sprite;\r\n            renderer.sprites[this.id] = sprite;\r\n            sprite.id = this.id;\r\n            sprite.position.set(this.position.x, this.position.y);\r\n            renderer.layer2.addChild(sprite);\r\n\r\n            if (gameEngine.isOwnedByPlayer(this)) {\r\n                renderer.addPlayerShip(sprite);\r\n            } else {\r\n                renderer.addOffscreenIndicator(this);\r\n            }\r\n        }\r\n    }\r\n\r\n    onRemoveFromWorld(gameEngine) {\r\n\r\n        if (this.fireLoop) {\r\n            this.fireLoop.destroy();\r\n        }\r\n\r\n        if (this.onPreStep) {\r\n            this.gameEngine.removeListener('preStep', this.onPreStep);\r\n            this.onPreStep = null;\r\n        }\r\n\r\n        if (Renderer) {\r\n            let renderer = Renderer.getInstance();\r\n            if (gameEngine.isOwnedByPlayer(this)) {\r\n                renderer.playerShip = null;\r\n            } else {\r\n                renderer.removeOffscreenIndicator(this);\r\n            }\r\n            let sprite = renderer.sprites[this.id];\r\n            if (sprite) {\r\n                if (sprite.actor) {\r\n                    // removal \"takes time\"\r\n                    sprite.actor.destroy().then(() => {\r\n                        delete renderer.sprites[this.id];\r\n                    });\r\n                } else {\r\n                    sprite.destroy();\r\n                    delete renderer.sprites[this.id];\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // no bending corrections on angle needed, angle is deterministic\r\n    // position correction if less than world width/height\r\n    get bending() {\r\n        return { angleLocal: { percent: 1.0 }, position: { max: 500.0 } };\r\n    }\r\n\r\n    static get netScheme() {\r\n        return Object.assign({\r\n            showThrust: { type: BaseTypes.TYPES.INT32 }\r\n        }, super.netScheme);\r\n    }\r\n\r\n    toString() {\r\n        return `${this.isBot?'Bot':'Player'}::Ship::${super.toString()}`;\r\n    }\r\n\r\n    syncTo(other) {\r\n        super.syncTo(other);\r\n        this.showThrust = other.showThrust;\r\n    }\r\n\r\n\r\n    destroy() {}\r\n\r\n    attachAI() {\r\n        this.isBot = true;\r\n\r\n        this.onPreStep = () => {\r\n            this.steer();\r\n        };\r\n\r\n        this.gameEngine.on('preStep', this.onPreStep);\r\n\r\n        let fireLoopTime = Math.round(250 + Math.random() * 100);\r\n        this.fireLoop = this.gameEngine.timer.loop(fireLoopTime, () => {\r\n            if (this.target && this.distanceToTargetSquared(this.target) < 160000) {\r\n                this.gameEngine.makeMissile(this);\r\n            }\r\n        });\r\n    }\r\n\r\n    shortestVector(p1, p2, wrapDist) {\r\n        let d = Math.abs(p2 - p1);\r\n        if (d > Math.abs(p2 + wrapDist - p1)) p2 += wrapDist;\r\n        else if (d > Math.abs(p1 + wrapDist - p2)) p1 += wrapDist;\r\n        return p2 - p1;\r\n    }\r\n\r\n    distanceToTargetSquared(target) {\r\n        let dx = this.shortestVector(this.position.x, target.position.x, this.gameEngine.worldSettings.width);\r\n        let dy = this.shortestVector(this.position.y, target.position.y, this.gameEngine.worldSettings.height);\r\n        return dx * dx + dy * dy;\r\n    }\r\n\r\n    steer() {\r\n        let closestTarget = null;\r\n        let closestDistance2 = Infinity;\r\n        for (let objId of Object.keys(this.gameEngine.world.objects)) {\r\n            let obj = this.gameEngine.world.objects[objId];\r\n            if (obj != this) {\r\n                let distance2 = this.distanceToTargetSquared(obj);\r\n                if (distance2 < closestDistance2) {\r\n                    closestTarget = obj;\r\n                    closestDistance2 = distance2;\r\n                }\r\n            }\r\n        }\r\n\r\n        this.target = closestTarget;\r\n\r\n        if (this.target) {\r\n\r\n            let newVX = this.shortestVector(this.position.x, this.target.position.x, this.gameEngine.worldSettings.width);\r\n            let newVY = this.shortestVector(this.position.y, this.target.position.y, this.gameEngine.worldSettings.height);\r\n            let angleToTarget = Math.atan2(newVX, newVY) / Math.PI * 180;\r\n            angleToTarget *= -1;\r\n            angleToTarget += 90; // game uses zero angle on the right, clockwise\r\n            if (angleToTarget < 0) angleToTarget += 360;\r\n            let turnRight = this.shortestVector(this.angle, angleToTarget, 360);\r\n\r\n            if (turnRight > 4) {\r\n                this.turnRight(2.5);\r\n            } else if (turnRight < -4) {\r\n                this.turnLeft(2.5);\r\n            } else {\r\n                this.accelerate(0.05);\r\n                this.showThrust = 5;\r\n            }\r\n\r\n        }\r\n    }\r\n}"],"file":"Ship.js"}